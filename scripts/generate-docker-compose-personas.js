#!/usr/bin/env node

/**
 * Generate docker-compose.yml with services for all personas in personas/active/
 * This script automatically creates a Docker service for each persona YAML file
 */

const fs = require('fs');
const path = require('path');
const yaml = require('yaml');

// Load default configuration
const defaults = require('../src/config/defaults');

const personasDir = path.join(process.cwd(), 'personas', 'active');
const outputFile = path.join(process.cwd(), 'docker-compose.personas.yml');

// Base docker-compose template
const baseCompose = `# Auto-generated docker-compose configuration for concurrent persona scraping
# Generated by: scripts/generate-docker-compose-personas.js
# To regenerate: node scripts/generate-docker-compose-personas.js
#
# Usage:
#   - Run all personas concurrently: docker compose -f docker-compose.personas.yml up
#   - Run specific persona: docker compose -f docker-compose.personas.yml up scraper-persona-<persona_id>
#   - Run in background: docker compose -f docker-compose.personas.yml up -d
#   - Run interactively (for verification prompts): docker compose -f docker-compose.personas.yml run --rm -it scraper-persona-<persona_id>
#
# Environment Variables:
#   - USE_PROXY=false to disable proxy (adds --no-proxy flag)
#   - BLOCK_MEDIA=image,media to customize media blocking (adds --block-media flag)
#   - VERIFICATION_CODE=123456 to provide verification code (for Docker non-interactive mode)
#   Examples:
#     docker compose -f docker-compose.personas.yml up -e USE_PROXY=false
#     docker compose -f docker-compose.personas.yml up -e BLOCK_MEDIA=none
#     VERIFICATION_CODE=123456 docker compose -f docker-compose.personas.yml up

services:
`;

/**
 * Build shell command lines for Docker Compose
 * Docker Compose interprets $$ as $, so $${VAR} becomes ${VAR} in shell
 */
function buildCommandLines(personaId) {
  // Get default proxy setting from config (convert boolean to string for shell)
  const defaultProxyValue = defaults.proxy.enabled ? 'true' : 'false';
  
  // Docker Compose variable syntax: $${VAR} becomes ${VAR} in shell
  const varPrefix = '$${';
  
  const baseCmd = `CMD='node src/main.js --persona ${personaId} --headless';`;
  
  // Check USE_PROXY env var, default to config value
  const proxyCheck = `if [ \\"${varPrefix}USE_PROXY:-${defaultProxyValue}}\\" = 'false' ]; then CMD=\\"$$CMD --no-proxy\\"; fi;`;
  
  // Check BLOCK_MEDIA env var (optional)
  const blockMediaCheck = `if [ -n \\"${varPrefix}BLOCK_MEDIA}\\" ]; then CMD=\\"$$CMD --block-media \\\\\\"${varPrefix}BLOCK_MEDIA}\\\\\\"\\"; fi;`;
  
  const execCmd = 'exec $$CMD';
  
  return [baseCmd, proxyCheck, blockMediaCheck, execCmd];
}

function generatePersonaService(personaId, index) {
  // Sanitize persona ID for use in container/service names
  const sanitizedId = personaId.replace(/[^a-z0-9]/gi, '-').toLowerCase();
  
  const commandLines = buildCommandLines(personaId);
  
  return `  scraper-persona-${sanitizedId}:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    platform: linux/amd64
    container_name: instagram-scraper-${sanitizedId}
    restart: unless-stopped
    stdin_open: true  # Enable stdin for interactive prompts
    tty: true         # Allocate a pseudo-TTY for interactive prompts
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=\${LOG_LEVEL:-info}
      - PERSONA_ID=${personaId}
      - VERIFICATION_CODE=\${VERIFICATION_CODE:-}  # Optional: set verification code via env var
      # Optional: Set USE_PROXY=false to disable proxy (adds --no-proxy flag)
      # - USE_PROXY=false
      # Optional: Set BLOCK_MEDIA to customize media blocking (adds --block-media flag)
      # Examples: BLOCK_MEDIA=image,media  or  BLOCK_MEDIA=none  or  BLOCK_MEDIA=all
      # - BLOCK_MEDIA=image,media
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./personas:/app/personas:ro
    # Supports environment variables USE_PROXY, BLOCK_MEDIA, and VERIFICATION_CODE
    # Default USE_PROXY value comes from src/config/defaults.js (proxy.enabled)
    command: >
      sh -c "
      ${commandLines.map(line => `      ${line}`).join('\n')}
      "
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.5'
          memory: 512M
`;
}

function main() {
  console.log('Generating docker-compose.personas.yml from personas in personas/active/...\n');
  
  if (!fs.existsSync(personasDir)) {
    console.error(`Error: Personas directory not found: ${personasDir}`);
    process.exit(1);
  }

  // Find all YAML files
  const files = fs.readdirSync(personasDir)
    .filter(f => f.endsWith('.yaml') || f.endsWith('.yml'))
    .sort();

  if (files.length === 0) {
    console.error('No persona YAML files found in personas/active/');
    process.exit(1);
  }

  console.log(`Found ${files.length} persona file(s):`);
  
  let composeContent = baseCompose;
  const personaIds = [];

  // Process each persona file
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const filePath = path.join(personasDir, file);
    
    try {
      const content = fs.readFileSync(filePath, 'utf8');
      const persona = yaml.parse(content);
      
      if (!persona.persona_id) {
        console.warn(`  ⚠ ${file}: Missing persona_id, skipping`);
        continue;
      }
      
      const personaId = persona.persona_id;
      personaIds.push(personaId);
      
      console.log(`  ✓ ${file} -> ${personaId}`);
      
      // Generate service definition
      composeContent += generatePersonaService(personaId, i);
      
      if (i < files.length - 1) {
        composeContent += '\n';
      }
    } catch (error) {
      console.error(`  ✗ ${file}: Error parsing - ${error.message}`);
    }
  }

  // Write the generated compose file
  fs.writeFileSync(outputFile, composeContent);
  
  console.log(`\n✓ Generated ${outputFile}`);
  console.log(`\nTo run all personas concurrently:`);
  console.log(`  docker compose -f docker-compose.personas.yml up`);
  console.log(`\nTo run in background:`);
  console.log(`  docker compose -f docker-compose.personas.yml up -d`);
  console.log(`\nTo run specific persona:`);
  if (personaIds.length > 0) {
    console.log(`  docker compose -f docker-compose.personas.yml up scraper-persona-${personaIds[0].replace(/[^a-z0-9]/gi, '-').toLowerCase()}`);
  }
  console.log(`\nTo view logs:`);
  console.log(`  docker compose -f docker-compose.personas.yml logs -f`);
}

main();

